---
layout: post
title: SQL Server 2014 : WHAT-WHY-HOW "In-Memory OLTP"
date: 2014-07-07 12:18
author: techforumugm
comments: true
categories: [MS SQLServer, Performance Tuning]
---
<br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;"><span style="font-family:Calibri;">WHAT</span></span></div><span style="font-family:Calibri;"><span style="font-family:Calibri;">In-memory OLTP  is a memory-optimized database engine integrated with SQL Server engine. It  optimized OLTP operations. It massively improve performance and scalability of  databases and by that applications will be speed up.</span><br /><br />  </span><div style="margin:0 0 8pt;"><span style="font-family:Calibri;"><span style="font-family:Calibri;">Its main  mechanism is that it allows you to declare a table to be stored in main memory  which is called memory optimized table. That reduce OLTP workload and provide  faster accessibility. Different data and index structure are introduced in  memory optimized tables and no data pages, no locking or latching, index pages  or buffer pool are used. SQL Server was designed to store data in the disk based  tables for persistence and bring data in memory when needed for serving query  requests. In memory optimized tables data are already stored in the  memory.</span></span></div><span style="font-family:Calibri;"><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">WHY </span></div><ol><li>Data insertion rate is memory-optimized tables is high from different  connection. <li>All the data for memory-optimized tables is in memory no buffer pool or  cache is used. <li>Durable in-memory tables are fully ACID-compliant so no data loss in  committed records. <li>It uses latch-free data structures and optimistic, multi-version concurrency  control. <li>No blocking is happened in concurrent transactions which enabling fully  utilization of CPU. <li>You will get major performance using natively compiled stored procedures  than interpreted stored procedures at the time of accessing a memory-optimized  table. <li>Code execution time become lower by reducing latency and improved  throughput. <li>You use new memory-optimized tables with old disk-based tables together in  same database. <li>Logical locks are eliminated through Optimistic concurrency control. <li>It has extremely high session concurrency for OLTP type of transactions  driven from a highly scaled-out middle-tier.</li></li></li></li></li></li></li></li></li></li></ol><br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">How</span></div><br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">Step 1:  </span><span style="font-family:Calibri;">You have a prerequisite for creating  memory optimized table:</span></div><br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">                When create a new  database:</span></div><br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">                        Create database with a  filestream filegroup </span></div><br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">                        (Using CONTAINS  MEMORY_OPTIMIZED_DATA) </span></div><br /><div style="margin:0 0 8pt;"><span style="font-family:Calibri;">            When you work on existing  database:</span></div>            Alter an existing database to add a filestream  filegroup<br /><br /><br />Step 2: We are going to create a traditional Database  so  that we may differentiate :       <br /><br /> <br /><div class="reCodeBlock" style="-ms-overflow-y:auto;border:1px solid rgb(127,157,185);"><div style="background-color:white;"><code style="color:black;">USE master  </code></div><div style="background-color:#f8f8f8;"><code style="color:black;">GO  </code></div><div style="background-color:white;"><code style="color:#006699;font-weight:bold;">CREATE</code> <code style="color:#006699;font-weight:bold;">DATABASE</code> <code style="color:black;">DBInMemoryOLTP1 </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">ON</code></div><div style="background-color:white;"><code style="color:#006699;font-weight:bold;">PRIMARY</code><code style="color:black;">(  </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">NAME</code> <code style="color:black;">=  [DBInMemoryOLTP_data],  </code></div><div style="background-color:white;"><code style="color:black;">FILENAME =  </code><code style="color:blue;">'c:\database\DBInMemoryOLTP_data.mdf'</code><code style="color:black;">, </code><code style="color:#006699;font-weight:bold;">SIZE</code> <code style="color:black;">=  1000MB </code></div><div style="background-color:#f8f8f8;"><code style="color:black;">)   </code></div><div style="background-color:white;"><code style="color:black;">LOG  </code><code style="color:#006699;font-weight:bold;">ON</code> <code style="color:black;">( </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">NAME</code> <code style="color:black;">=  [DBInMemoryOLTP_log],  </code></div><div style="background-color:white;"><code style="color:black;">FILENAME =  </code><code style="color:blue;">'C:\database\DBInMemoryOLTP_log.ldf'</code><code style="color:black;">, </code><code style="color:#006699;font-weight:bold;">SIZE</code> <code style="color:black;">=  50MB </code></div><div style="background-color:#f8f8f8;"><code style="color:black;">)</code></div></div><br /><div style="margin:0 0 8pt;">Step 3: Add file Group  having memory-optimized  tables :<br /><br /></div><br /><div class="reCodeBlock" style="-ms-overflow-y:auto;border:1px solid rgb(127,157,185);"><div style="background-color:white;"><code style="color:black;">Use  DBInMemoryOLTP </code></div><div style="background-color:#f8f8f8;"><code style="color:black;">Go  </code></div><div style="background-color:white;"><code style="color:#006699;font-weight:bold;">ALTER</code> <code style="color:#006699;font-weight:bold;">DATABASE</code> <code style="color:black;">DBInMemoryOLTP </code><code style="color:#006699;font-weight:bold;">ADD</code> <code style="color:black;">FILEGROUP [DBInMemoryOLTP_data]  </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">CONTAINS</code> <code style="color:black;">MEMORY_OPTIMIZED_DATA </code></div><div style="background-color:white;"><code style="color:black;">GO  </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">ALTER</code> <code style="color:#006699;font-weight:bold;">DATABASE</code> <code style="color:black;">DBInMemoryOLTP </code><code style="color:#006699;font-weight:bold;">ADD</code> <code style="color:black;">FILE  </code></div><div style="background-color:white;"><code style="color:black;">(   </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">NAME</code> <code style="color:black;">=  [DBInMemoryOLTP_FG1],  </code></div><div style="background-color:white;"><code style="color:black;">FILENAME =  </code><code style="color:blue;">'c:\database\DBInMemoryOLTP_FG1'</code></div><div style="background-color:#f8f8f8;"><code style="color:black;">)  </code><code style="color:#006699;font-weight:bold;">TO</code> <code style="color:black;">FILEGROUP [DBInMemoryOLTP_data] </code></div><div style="background-color:white;"><code style="color:black;">GO  </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">ALTER</code> <code style="color:#006699;font-weight:bold;">DATABASE</code> <code style="color:black;">DBInMemoryOLTP </code><code style="color:#006699;font-weight:bold;">ADD</code> <code style="color:black;">FILE  </code></div><div style="background-color:white;"><code style="color:black;">(  </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">NAME</code> <code style="color:black;">=  [DBInMemoryOLTP_FG2],  </code></div><div style="background-color:white;"><code style="color:black;">FILENAME =  </code><code style="color:blue;">'c:\database\DBInMemoryOLTP_FG2'</code></div><div style="background-color:#f8f8f8;"><code style="color:black;">)  </code><code style="color:#006699;font-weight:bold;">TO</code> <code style="color:black;">FILEGROUP [DBInMemoryOLTP_data]  </code></div><div style="background-color:white;"><code style="color:black;">GO</code></div></div><br /><div style="margin:0 0 8pt;">Step 4: Now we are going to create a  memory-optimized table:</div><br /><div class="reCodeBlock" style="-ms-overflow-y:auto;border:1px solid rgb(127,157,185);"><div style="background-color:white;"><code style="color:#006699;font-weight:bold;">CREATE</code> <code style="color:#006699;font-weight:bold;">TABLE</code> <code style="color:black;">[techforum_member_list]( </code></div><div style="background-color:#f8f8f8;"><code style="color:black;">[TfmID]  </code><code style="color:#006699;font-weight:bold;">INT</code> <code style="color:grey;">NOT</code> <code style="color:grey;">NULL</code> <code style="color:#006699;font-weight:bold;">PRIMARY</code> <code style="color:#006699;font-weight:bold;">KEY</code> <code style="color:black;">NONCLUSTERED HASH </code><code style="color:#006699;font-weight:bold;">WITH</code> <code style="color:black;">(BUCKET_COUNT = 500000), </code></div><div style="background-color:white;"><code style="color:black;">[</code><code style="color:#006699;font-weight:bold;">Name</code><code style="color:black;">]  NVARCHAR(50) </code><code style="color:#006699;font-weight:bold;">COLLATE</code>  <code style="color:black;">Latin1_General_100_BIN2 </code><code style="color:grey;">NOT</code> <code style="color:grey;">NULL</code> <code style="color:#006699;font-weight:bold;">INDEX</code> <code style="color:black;">[IName] HASH </code><code style="color:#006699;font-weight:bold;">WITH</code> <code style="color:black;">(BUCKET_COUNT = 500000), </code></div><div style="background-color:#f8f8f8;"><code style="color:black;">[JoiningDate] DATETIME </code><code style="color:grey;">NULL</code></div><div style="background-color:white;"><code style="color:black;">)  </code></div><div style="background-color:#f8f8f8;"><code style="color:#006699;font-weight:bold;">WITH</code> <code style="color:black;">(MEMORY_OPTIMIZED = </code><code style="color:#006699;font-weight:bold;">ON</code><code style="color:black;">,  DURABILITY = SCHEMA_AND_DATA); </code></div></div><br /><div style="margin:0 0 8pt;">Step 5: To understand the advantage we are going  to input sample data into the newly created table. Make Select query to feel the  new experience :</div><br /><div class="reCodeBlock" style="-ms-overflow-y:auto;border:1px solid rgb(127,157,185);"><div style="background-color:white;"><code style="color:#006699;font-weight:bold;">Declare</code> <code style="color:black;">@i </code><code style="color:#006699;font-weight:bold;">as</code> <code style="color:#006699;font-weight:bold;">bigint</code><code style="color:black;">=1  </code></div><div style="background-color:#f8f8f8;"><code>     </code> </div><div style="background-color:white;"><code style="color:black;">While ( @i  &lt; 500000) </code></div><div style="background-color:#f8f8f8;"><code>    </code><code style="color:#006699;font-weight:bold;">Begin</code></div><div style="background-color:white;"><code>        </code><code style="color:#006699;font-weight:bold;">Insert</code> <code style="color:#006699;font-weight:bold;">into</code> <code style="color:black;">techforum_member_list </code><code style="color:#006699;font-weight:bold;">values</code> <code style="color:black;">(@i,</code><code style="color:blue;">'techforum'</code><code style="color:black;">+</code><code style="color:deeppink;">cast</code><code style="color:black;">(@i </code><code style="color:#006699;font-weight:bold;">as</code> <code style="color:black;">nvarchar(50)),GETDATE() ) </code></div><div style="background-color:#f8f8f8;"><code>        </code><code style="color:#006699;font-weight:bold;">Set</code> <code style="color:black;">@i+=1 </code></div><div style="background-color:white;"><code>    </code><code style="color:#006699;font-weight:bold;">End</code> </div><div style="background-color:#f8f8f8;"><code>     </code> </div><div style="background-color:white;"><code> </code><code style="color:#006699;font-weight:bold;">Select</code> <code style="color:black;">*  </code><code style="color:#006699;font-weight:bold;">from</code> <code style="color:black;">techforum_member_list</code></div></div><br /><div style="margin:0 0 8pt;">You will be wonder that all data will be  retrieved from database within 1 sec.</div></span><br /><div class="separator" style="clear:both;text-align:center;"><a href="https://techforumugm.files.wordpress.com/2014/07/3dcf2-sample1.jpg" style="margin-left:1em;margin-right:1em;"><img border="0" src="https://techforumugm.files.wordpress.com/2014/07/3dcf2-sample1.jpg" height="166" width="320" /></a></div><br />
